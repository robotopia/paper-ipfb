\documentclass{pasa}%

\usepackage{graphicx}

\DeclareMathOperator{\sinc}{sinc}

\title[MWA tied-array processing III]{MWA tied-array processing III: Microsecond time resolution via a synthesis filter}

%%% SAMPLE %%%
%% Please note that the command \and is not supported in \author.
%\author[Author1 et al.]{Author1$^1$, Author2$^2$, Author3$^2$ and Author4$^{2,}$\thanks{This is an example of author footnote}
%\affil{$^1$This is  an example of Affiliation r Author 1}%
%\affil{$^2$This is  an example of Affiliation for Author 2}
%}%
%%% END SAMPLE %%%

\author[McSweeney et al.]{S. J. McSweeney$^1$, S. M. Ord$^2$, D. Kaur$^1$, N. D. R. Bhat$^1$
\affil{$^1$International Centre for Radio Astronomy Research (ICRAR), GPO Box U1987, Perth, WA 6845, Australia}%
\affil{$^2$CSIRO Astronomy and Space Science, PO Box 76, Epping, NSW 1710, Australia}
}

\jid{PASA}
\doi{10.1017/pas.\the\year.xxx}
\jyear{\the\year}

\usepackage{aas_macros}
\usepackage{hyperref} 
\hypersetup{colorlinks,citecolor=blue,linkcolor=blue,urlcolor=blue}

%%%%%%% IMPORTANT: We disable hyperlinks by default with this line, to avoid the error "\pdfendlink ended up in different nesting level" while writing.
\hypersetup{draft}
%%%%%%% You may comment or delete the line above to make hyperlinks in your paper active. If you then encounter a strange "\pdfendlink ended up in different nesting level than \pdfstartlink", don't worry! Uncomment the line again, and see https://www.overleaf.com/help/246 for further information.

\begin{document}

\begin{frontmatter}
\maketitle

\begin{abstract}
[Abstract\dots]
\end{abstract}

\begin{keywords}
    instrumentation: interferometers -- pulsars: general -- techniques: interferometric
\end{keywords}
\end{frontmatter}


\section{INTRODUCTION}
\label{sec:intro}

Some of the most exciting advances in time-domain astronomy have only been made possible by pushing the capabilities of latest generation telescopes to be sensitive to signals of shorter and shorter duration.
The serendipitous discovery of pulsars in the late 1960's is perhaps the prototypical example \citep{Hewish1968}.
In more recent times, the ongoing effort to detect nanohertz gravitational waves by means of pulsar timing arrays requires the continual monitoring of the times of arrival (TOAs) of millisecond pulsars (MSPs) with microsecond accuracy (CITATIONS).
Pulsars are also known to exhibit temporal structures on microsecond and even nanosecond time scales, providing major clues for the underlying radio emission mechanism (CITATIONS).
Similarly, fast radio bursts (FRBs) have been shown to exhibit temporal sub-millisecond structures that either point to the intrinsic emission mechanism or to interesting propagation effects occurring in the intergalactic medium (CITATIONS).
All of these examples serve to illustrate the scientifically important and still largely untapped parameter space that is only accessible to telescopes equipped with a sufficiently high time resolution observing mode.

The Murchison Widefield Array \citep[MWA;][]{Tingay2013} is a low-frequency ($\sim80$ to $300\,$MHz) aperture array telescope located at the Murchison Radio Observatory (MRO) in Western Australia.
Now in its second phase of development \citep[Phase II;][]{Wayth2018}, it consists of 256 `tiles' (sets of $4\times4$ cross-dipole antennas) distributed over an area approximately $5.3\,$km in diameter, 128 of which can be used at a single time to form an interferometer.
Originally conceived as an imaging telescope (which requires only the time-averaged cross-correlation products of the tiles, or `visibilities', to be retained on disk), it was subsequently augmented with the functionality to capture the raw complex voltages of each tile, known as the Voltage Capture System \citep[VCS;][]{Tremblay2015}.
This system has enabled the MWA to be used as a premier instrument for high-time resolution studies of transient signals, especially pulsars.

Although the tile voltages are sampled at a (Nyquist) rate of $655.36\,$MHz, these data undergo several stages of processing before finally being written to disk.
After preliminary filtering and digitisation, the raw voltages are subjected to a two-stage frequency analysis filter, which trades time resolution for increased frequency resolution.
In the MWA's case, both stages of the analysis filter were implemented as polyphase filterbanks \citep[PFBs;][\dots]{Harris2011,Prabu2015}.
The first stage (`coarse') PFB reduces the effecting sampling rate by a factor of 512, resulting in an array of complex-valued samples with $1.28\,$MHz resolution in frequency (`coarse' channels) and $\sim0.8\,\mu$s in time.
In the second stage (`fine') PFB, each coarse channel is further split into $128 \times 10\,$kHz `fine' channels at the cost of decreasing the time resolution to $100\,\mu$s.

In the current MWA system design, only the latter time resolution data product (i.e. $100\,\mu$s) is made available to the user.
While this is sufficient for many pulsar studies \citep[e.g.][]{Oronsaye2015,McSweeney2017,Bhat2018}, it is nevertheless too coarse for many science applications involving MSPs.
In principle, the original higher time resolution can be recovered from the channelised output (either approximately or exactly) by means of a \textit{synthesis filter}, which acts as an `inverse' operation to the analysis filter.
The conditions under which the original time series can be exactly reproduced depends on the choice of analysis and synthesis filters.

Here, we describe the synthesis filter that is implemented as the (optional) final stage of the tied-array beamforming pipeline, the former stages of which are described in detail in \citet[][hereafter Paper I]{Ord2019} and \citet[][hereafter Paper II]{Xue2019}.
The synthesis filter is applied to the fine-channel output of the beamformer, and recovers the coarse channel time series.
That is, it effectively `undoes' the fine PFB, increasing the available time resolution to $\sim 0.8\,\mu$s.
A brief review of PFBs in general, and their particular implementation in the case of the MWA, are given in \S\ref{sec:pfb}.
The design of the synthesis filter is described in \S\ref{sec:ipfb}, including a discussion of its fidelity, i.e., the appearance of any temporal and spectral artefacts introduced by the synthesis filter itself.
Finally, the practical use of this functionality is demonstrated through two examples: MWA observations of the MSPs J2241$-$5236 and J0437$-$4715.

\section{Polyphase filterbanks (PFBs)}
\label{sec:pfb}

PFBs are a type of analysis filter, designed to extract spectral information out of discrete time series data.
They can be considered a generalisation of the more familiar discrete Fourier transform (DFT), and are designed to overcome the undesirably uneven frequency response (i.e. spectral leakage) inherent in the application of DFTs to discretely sampled time series of finite length.
They are well described in standard texts \citep{Crochiere1983,Harris2004,Oppenheim2009}; a clear and concise review of PFBs in the context of radio astronomy is given in \citet{Harris2011}, whose notation is closely followed here.
Thus, only a brief review of the salient features is given, in order to prepare the reader for the description of the synthesis filter in the following sections.

\subsection{General review and mathematical notation}

Like the DFT, the PFB is a transformation from the time domain, $x[n]$, to the frequency domain $X[k]$, where the $[\cdot]$ notation denotes a discretised index, and where $n,k \in \mathbb{Z}$ are the indices for time and frequency, respectively.
Let $N$ be the number of (equally spaced) frequency channels required for some desired spectral resolution.
Although applying a DFT to $N$ adjacent time samples will produce the desired resolution, the result will be an imperfect representation of the true spectral content of $x[n]$ because of \textit{spectral leakage}, which is when power that properly `belongs' to some particular frequency bin appears in (or, is \textit{aliased} to) other, nearby bins.
The impossibility of perfectly eliminating spectral leakage can be seen by realising that operating on a finite-length time series is equivalent to multiplying an arbitrarily long time series with a rectangular window function,
\begin{equation}
    w_R[n] = \begin{cases} 1, & 0 \le n < N, \\ 0, & \text{elsewhere}, \end{cases}
\end{equation}
whose effect in the frequency domain is to convolve the ``true'' spectrum of the signal with the Fourier transform of the window function.
In the case of a rectangular window, this is the sinc function.

A common strategy for mitigating spectral leakage is to choose an alternative window function whose Fourier pair is localised in the frequency domain, and which therefore produces a tolerable level of spectral leakage when convolved with the signal's spectrum.
Many possible windowing functions have been identified, which in general trade the `amount' of leakage with the `location' of the leaked components.
For our purposes, it is sufficient to note that the inevitable presence of a windowing function motivates the definition of the \textit{analysis filter}, $h[n]$, and the generalised \textit{windowed DFT}
\begin{equation}
    X[k] = \sum_{n=0}^{N-1} h[n]\,x[n]\,e^{-2\pi j k (n/N)},
    \label{eqn:wdft}
\end{equation}
where $j = \sqrt{-1}$ denotes the imaginary number, and it is understood that $0 \le k < N$.
The choice of $h[n]$ is motivated by the shape of its \textit{frequency response} (i.e. its Fourier pair), whose characteristics (e.g. width, location of sidelobes) might carry particular advantages in certain contexts.
Note that leaving $x[n]$ ``unweighted'' is equivalent to choosing $h[n] = w_R[n]$.

It is well known that scaling a function in the time domain produces the inverse scaling in the Fourier domain.
This fact motivates an alternative strategy for mitigating spectral leakage.
If more samples are available, say $M = NP$ for $P > 1$, then stretching (i.e. scaling and upsampling) the analysis filter will result in a frequency response function that is similar in shape, but $P$ times narrower than the original analysis filter.
Applying the DFT to the larger set of windowed samples and subsequently \emph{downsampling} the resulting spectrum (by choosing every $P$th frequency bin and rejecting the rest) ensures that the original desired spectral resolution is retained, but with significantly less spectral leakage.

The algorithm embodied in the above strategy defines the PFB.
It is clear that choosing a larger value for $P$ will lessen spectral leakage by the same factor, but this naturally comes at a greater computational cost, since the DFT is now applied to $M$ samples.
However, one of the great advantages of the PFB is that the above operations of using a wider analysis wilter and downsampling the resulting spectrum are mathematically equivalent to first segmenting the windowed time series into $P$ segments (known as `taps') of size $N$, summing their respective samples element-wise, and performing a single DFT on the resulting array (now of size $N$), i.e.
\begin{equation}
    X[k] = \sum_{n=0}^{N-1} b[n]\,e^{-2\pi j k (n/N)},
    \label{eqn:pfb}
\end{equation}
where
\begin{equation*}
    b[n] = \sum_{\rho=0}^{P-1} h[n + N\rho]\,x[n + N\rho].
\end{equation*}
A short proof of the equivalence of this expression with the algorithm described above is given in \citet{Harris2011}.
The term `polyphase' derives from the structure of $b[n]$ defined in Eq. \eqref{eqn:pfb}.
It is illustrated in Fig. \ref{fig:pfb}.
\begin{figure}
    \centering
    \includegraphics[width=\columnwidth]{example-image-a}
    \caption{A diagramatic representation of the PFB algorithm, as defined in Eq. \eqref{eqn:pfb}.}
    \label{fig:pfb}
\end{figure}

% There is some ambiguity about whether this definition includes the correct set of phases, which differ depending on whether the filterbank is defined on [0,M) or [-M/2, M/2).
% It may turn out there is an extra phase ramp that's needed in Eq. \eqref{eqn:filter} below.
% See Harris et al. (2011) for a fuller discussion of this point.

\subsection{MWA implementation of the fine PFB}

The first stage (coarse) PFB is described in \citet{Prabu2015}, and here we only document a few details pertaining to the second stage (fine) PFB.
A PFB is completely specified by (1) the number of output channels, $N$, (2) the number of taps, $P$, and (3) the analysis filter, $h[m]$, $0 \le m < M=NP$.
For the MWA, $N=128$ (giving fine channels $10\,$kHz wide), $P=12$, and
\begin{equation}
    h[m] = w_H[m]\,w_s[m],
    \label{eqn:filter}
\end{equation}
where
\begin{equation*}
    w_H[m] = \sin^2\bigg(\frac{\pi (m+1)}{M+1}\bigg)
\end{equation*}
is the Hanning window, and
\begin{equation*}
    w_s[m] = \sinc\bigg(\frac{\pi(m + 1 - M/2)}{N}\bigg)
\end{equation*}
is the scaled $\sinc(x) = \sin(x)/x$ function.
It can be easily checked that $h[m]$ is defined to be symmetric around sample $m = 767 = M/2-1$.
The analysis filter is shown in Fig. \ref{fig:filter}.
\begin{figure}
    \centering
    \includegraphics[width=\columnwidth]{filter}
    \caption{Top: The coefficients of the analysis filter defined in Eq. \eqref{eqn:filter}, composed of a Hanning window multiplied to a $\sinc$ function. Bottom: The frequency response of the analysis filter, showing negligible attenuation across approximately $10\,$kHz (the bandwidth of a fine channel) and strong attenuation elsewhere.}
    \label{fig:filter}
\end{figure}

The above specifications yield a specific frequency response, as explained in the preceding section.
The rationale behind these particular design choices is beyond the scope of this paper---for the purposes of creating a synthesis filter, it is sufficient to know merely how the analysis filter is defined\footnote{Eq. \eqref{eqn:filter} is defined on $\mathbb{R}$, but the actual implementation on the MWA's filed-programmable gate arrays (FPGAs) defines the analysis filter coefficients on $\mathbb{Z}$. The exact implemented values, $h^\ast[m]$, can be obtained from $h[m]$ via $h^\ast[m] \equiv \lfloor\alpha h[m]\rceil$, where $\lfloor\cdot\rceil$ denotes rounding to the nearest integer and $\alpha = 117963.875$.}.

\section{Synthesis filter}
\label{sec:ipfb}

\subsection{Design}

\subsection{Implementation}

\subsection{Fidelity}


%%% SAMPLE %%%
%\begin{table}
%\caption{This is an example of table caption.}
%\centering
%\begin{tabular}{@{}cc@{}}
%\hline\hline
%Dimension & Classification accuracy \\
%\hline%
% 1  & 0.6232$^{(a)}$ \\
% 2  & 0.9635 \\ 
% 3  & 0.9724 \\ 
% 4  & 0.9690 \\ 
% 5  & 0.9840 \\ 
% 6  & 0.9842 \\ 
% 7  & 0.9873 \\ 
% 8  & 0.9884 \\
% 9  & 0.9873 \\ 
% 10 & 0.9898 \\ 
% 11 & 0.9914 \\
%\hline\hline
%\end{tabular}
%\label{tab1}
%\medskip
%\tabnote{$^a$This is an example of table footnote}
%\tabnote{This is an example of table footnote}
%\tabnote{This is an example of table footnote}
%\end{table}
% 
%\begin{acknowledgements}
%This is a multiline text of acknowledgments. We are met here on a great battlefield of that war. We have come to dedicate a portion of it as a final resting place for those who here gave their lives that that nation might live.
%\end{acknowledgements}
%
%
%\begin{appendix}
%
%\section{AN EXAMPLE OF APPENDIX HEAD}
%
% Consider a data set
%\begin{equation}
%S=(f_{ij})_{m\times n}
%\end{equation} the \(i\)th
%data point of which is
%\[ (f_{i1}, . . . , f_{in}).\]
% Let $\overline{f}_q=\frac{1}{m}\sum_{i=1}^mf_{iq}$ and $\sigma_q$ The brave men, living and dead, who struggled, here, have consecrated it far above our poor power to add or detract. Suppose that
%\[X_i=(x_{i1},\dots,x_{in}) \indent (i=1,\dots, m),\]  
%where $x_{ij}=(f_{ij}-\overline{f}_j)/\sigma_j $ and
%\[B=(X_1^T,\dots,X_m^T)^T.\]
% Then we can show that
%\[C=B^TB=\sum\limits_{i=1}^m X_i^TX_i=(C_{jk})_{n\times n},\]
%where $C_{jk}=\sum_{i=1}^mx_{ij}x_{ik}$ is the correlation matrix. Our goal is to find a normalized vector 
%$$a_1=(a_{11},a_{12},\dots,a_{1n})^T$$
% such that the projection of the standardized data
%\[X_ia_1=\sum\limits_{k=1}^n x_{ik}a_{1k},\]
%\noindent then $Ba_1$ 
% \[a_1^TB^T ¡¤ Ba_1=a_1^TCa_1.\]
% Our goal is to maximize this value under the constraint $a_1^Ta_1=1$. Let $\lambda_{\rm max}$ be the largest eigenvalue of
% $C$. According to the Rayleigh--Ritz theorem, $a_1$ can be obtained by solving
% \[Ca_1= \lambda_{\rm max}a_1.\]
%But in a larger sense we can not dedicate -- we can not consecrate -- we can not hallow this ground. The brave men, living and dead, who struggled, here, have consecrated it far above our poor power to add or detract. The world will little note, nor long remember, what we say here, but can never forget what they did here. It is for us, the living, rather to be dedicated here to the unfinished work which they have, thus far, so nobly carried on \cite{abt1981}. It is rather for us to be here dedicated to the great task remaining before us  that from these honoured dead we take increased devotion to that cause for which they here gave the last full measure of devotion  that we here highly resolve that these dead shall not have died in vain; that this nation shall have a new birth of freedom; and that this government \cite{abt1984b} of the people, by the people, for the people, shall not perish from the earth.
%\end{appendix}
%%% END SAMPLE %%%

\bibliographystyle{pasa-mnras}
\bibliography{biblio.bib}

\end{document}
