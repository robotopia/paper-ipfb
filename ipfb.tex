\documentclass{pasa}%

\usepackage{graphicx}

\DeclareMathOperator{\sinc}{sinc}
\newcommand{\Kron}{\delta_s^0}
\newcommand{\vcstools}{VCSTools}
\newcommand{\bname}{B0950$+$08}
\newcommand{\jname}{J0953$+$0755}

\title[MWA tied-array processing III]{MWA tied-array processing III: Microsecond time resolution via a synthesis filter}

%%% SAMPLE %%%
%% Please note that the command \and is not supported in \author.
%\author[Author1 et al.]{Author1$^1$, Author2$^2$, Author3$^2$ and Author4$^{2,}$\thanks{This is an example of author footnote}
%\affil{$^1$This is  an example of Affiliation r Author 1}%
%\affil{$^2$This is  an example of Affiliation for Author 2}
%}%
%%% END SAMPLE %%%

\author[McSweeney et al.]{S. J. McSweeney$^1$, S. M. Ord$^2$, D. Kaur$^1$, N. D. R. Bhat$^1$, B. W. Meyers$^{1,2,3}$, S. E. Tremblay, J. Jones, B. Crosse
\affil{$^1$International Centre for Radio Astronomy Research (ICRAR), GPO Box U1987, Perth, WA 6845, Australia}%
\affil{$^2$CSIRO Astronomy and Space Science, PO Box 76, Epping, NSW 1710, Australia}
\affil{$^3$Dept. of Physics and Astronomy, University of British Columbia, 6224 Agricultural Road, Vancouver, B.C., V6T 1Z1, Canada}
}

\jid{PASA}
\doi{10.1017/pas.\the\year.xxx}
\jyear{\the\year}

\usepackage{aas_macros}
\usepackage{hyperref}
\hypersetup{colorlinks,citecolor=blue,linkcolor=blue,urlcolor=blue}

%%%%%%% IMPORTANT: We disable hyperlinks by default with this line, to avoid the error "\pdfendlink ended up in different nesting level" while writing.
%\hypersetup{draft}
%%%%%%% You may comment or delete the line above to make hyperlinks in your paper active. If you then encounter a strange "\pdfendlink ended up in different nesting level than \pdfstartlink", don't worry! Uncomment the line again, and see https://www.overleaf.com/help/246 for further information.

\begin{document}

\begin{frontmatter}
\maketitle

\begin{abstract}
[Abstract\dots]
\end{abstract}

\begin{keywords}
    instrumentation: interferometers -- pulsars: general -- techniques: interferometric
\end{keywords}
\end{frontmatter}


\section{INTRODUCTION}
\label{sec:intro}

Some of the most exciting advances in time-domain astronomy have only been made possible by pushing the capabilities of latest generation telescopes to be sensitive to signals of shorter and shorter duration.
The serendipitous discovery of pulsars in the late 1960's is perhaps the prototypical example \citep{Hewish1968}.
In more recent times, the ongoing effort to detect nanohertz gravitational waves by means of pulsar timing arrays requires the continual monitoring of the times of arrival (TOAs) of millisecond pulsars (MSPs) with microsecond accuracy (CITATIONS).
Pulsars are also known to exhibit temporal structures on microsecond and even nanosecond time scales, providing major clues for the underlying radio emission mechanism (CITATIONS).
Similarly, fast radio bursts (FRBs) have been shown to exhibit temporal sub-millisecond structures that either point to the intrinsic emission mechanism or to interesting propagation effects occurring in the intergalactic medium (CITATIONS).
All of these examples serve to illustrate the scientifically important and still largely untapped parameter space that is only accessible to telescopes equipped with a sufficiently high time resolution observing mode.

The Murchison Widefield Array \citep[MWA;][]{Tingay2013} is a low-frequency ($\sim80$ to $300\,$MHz) aperture array telescope located at the Murchison Radio Observatory (MRO) in Western Australia.
Now in its second phase of development \citep[Phase II;][]{Wayth2018}, it consists of 256 `tiles' (sets of $4\times4$ cross-dipole antennas) distributed over an area approximately $5.3\,$km in diameter, 128 of which can be used at a single time to form an interferometer.
Originally conceived as an imaging telescope (which requires only the time-averaged cross-correlation products of the tiles, or `visibilities', to be retained on disk), it was subsequently augmented with the functionality to capture the raw complex voltages of each tile, known as the Voltage Capture System \citep[VCS;][]{Tremblay2015}.
This system has enabled the MWA to be used as a premier instrument for high-time resolution studies of transient signals, especially pulsars.

Although the tile voltages are sampled at a (Nyquist) rate of $655.36\,$MHz, these data undergo several stages of processing before finally being written to disk.
After preliminary filtering and digitisation, the raw voltages are subjected to a two-stage frequency analysis filter, which trades time resolution for increased frequency resolution.
In the MWA's case, both stages of the analysis filter were implemented as polyphase filterbanks \citep[PFBs;][\dots]{Harris2011,Prabu2015}.
The first stage (`coarse') PFB reduces the effecting sampling rate by a factor of 512, resulting in an array of complex-valued samples with $1.28\,$MHz resolution in frequency (`coarse' channels) and $\sim0.8\,\mu$s in time.
In the second stage (`fine') PFB, each coarse channel is further split into $128 \times 10\,$kHz `fine' channels at the cost of decreasing the time resolution to $100\,\mu$s.

In the current MWA system design, only the latter time resolution data product (i.e. $100\,\mu$s) is made available to the user.
While this is sufficient for many pulsar studies \citep[e.g.][]{Oronsaye2015,McSweeney2017,Bhat2018}, it is nevertheless too coarse for many science applications involving MSPs.
In principle, the original higher time resolution can be recovered from the channelised output (either approximately or exactly) by means of a \textit{synthesis filter}, which acts as an `inverse' operation to the analysis filter.
The conditions under which the original time series can be exactly reproduced depends on the choice of analysis and synthesis filters.

Here, we describe the synthesis filter that is implemented as the (optional) final stage of the tied-array beamforming pipeline, the former stages of which are described in detail in \citet[][hereafter Paper I]{Ord2019} and \citet[][hereafter Paper II]{Xue2019}.
The synthesis filter is applied to the fine-channel output of the beamformer, and recovers the coarse channel time series.
That is, it effectively `undoes' the fine PFB, increasing the available time resolution to $\sim 0.8\,\mu$s.
A brief review of PFBs in general, and their particular implementation in the case of the MWA, are given in Section \ref{sec:pfb}.
The design of the synthesis filter is described in Section \ref{sec:ipfb}, including a discussion of its fidelity, i.e., the appearance of any temporal and spectral artefacts introduced by the synthesis filter itself.
Finally, the practical use of this functionality is demonstrated in Section \ref{sec:pulsardata} through three examples: MWA observations of the PSRs J2241$-$5236, J0437$-$4715, and \bname{} (\jname{}).

\section{Polyphase filterbanks (PFBs)}
\label{sec:pfb}

PFBs are a type of analysis filter, designed to extract spectral information out of discrete time series data.
They can be considered a generalisation of the more familiar discrete Fourier transform (DFT), and are designed to overcome the undesirably uneven frequency response (i.e. spectral leakage) inherent in the application of DFTs to discretely sampled time series of finite length.
They are well described in standard texts \citep{Crochiere1983,Harris2004,Oppenheim2009}; a clear and concise review of PFBs in the context of radio astronomy is given in \citet{Harris2011}.
Thus, only a brief review of the salient features is given, in order to prepare the reader for the description of the synthesis filter in the following sections.

\subsection{General review and mathematical notation}

The PFB is a transformation from the time domain, $x[n]$, to the frequency domain $X_k[m]$, where the $[\cdot]$ notation denotes a discretised index, $k$ is the channel number, and $n,m \in \mathbb{Z}$ are the time indices for the pre- and post-channelised data, respectively.
Let $K$ be the number of (equally spaced) frequency channels required for some desired spectral resolution.
Although applying a DFT to $N = K$ adjacent time samples in $x[n]$ will produce the desired resolution, the result will be an imperfect representation of the true spectrum because of \textit{spectral leakage}, which is when power that properly `belongs' to some particular frequency bin appears in (or, is \textit{aliased} to) other, nearby bins.
The impossibility of perfectly eliminating spectral leakage can be seen by realising that operating on a finite-length time series is equivalent to multiplying an arbitrarily long time series with a rectangular window function,
\begin{equation}
    w_R[n] = \begin{cases} 1, & 0 \le n < N, \\ 0, & \text{elsewhere}, \end{cases}
\end{equation}
whose effect in the frequency domain is to convolve the ``true'' spectrum of the signal with the Fourier transform of the window function.
In the case of a rectangular window, this is the sinc function.

A common strategy for mitigating spectral leakage is to choose an alternative window function whose Fourier pair is localised in the frequency domain, and which therefore produces a tolerable level of spectral leakage when convolved with the signal's spectrum.
Many possible windowing functions have been identified, which in general trade the `amount' of leakage with the `location' of the leaked components.
For our purposes, it is sufficient to note that the inevitable presence of a windowing function motivates the definition of the \textit{analysis filter}, $h[n]$, and the generalised \textit{windowed DFT}
\begin{equation}
    X_k[m] = \sum_{n=0}^{N-1} h[mM - n]\,x[n]\,e^{-2\pi jkn/K},
    \label{eqn:wdft}
\end{equation}
where $j = \sqrt{-1}$ denotes the imaginary number, $m$ is the time index of the channelised (output) data, and $0 \le k < K$ denotes the channel number.
Eq. \eqref{eqn:wdft} describes the action of performing DFTs on short, windowed segments of the input time series of length $K$.
$M$ is the number of samples that the window is translated along $x[n]$ between successive DFT operations; thus, the index of $h[mM - n]$ represents the shift required in order to produce the spectrum at time $m$.
If $M < K$ then the windows overlap and the resulting channelisation is \textit{oversampled}; if $M = K$, then it is \textit{critically sampled}.
The choice of $h[n]$ is motivated by the shape of its \textit{frequency response} (i.e. its Fourier pair), whose characteristics (e.g. width, location of sidelobes) are chosen according to the advantages they carry in particular contexts.
Leaving $x[n]$ ``unweighted'' is equivalent to choosing $h[n] = w_R[n]$, in which case Eq. \eqref{eqn:wdft} is also called the short-time Fourier transform (STFT).
On the other hand, choosing $h[n]$ to be the $\sinc$ function will result in a frequency response that approximates a rectangular window.

It is well known that scaling a function in the time domain produces the inverse scaling in the Fourier domain.
This fact motivates an alternative strategy for mitigating spectral leakage.
Choosing a larger window size, $N = KP$ (for integer $P > 1$), and a corresponding wider analysis filter, will result in a frequency response that is similar in shape, but $P$ times narrower than the frequency response of the original analysis filter.
A DFT applied to the larger number of samples will naturally produce a correspondingly larger number of frequency channels, but choosing only every $P$th channel and discarding the rest (known as \textit{decimation}) ensures that the desired spectral resolution with $K$ channels is retained.
In this way, spectral leakage can be contained arbitrarily close to the ``correct'' channel by choosing a sufficiently high value of $P$.

The two-step algorithm described above (performing a windowed DFT on $N = KP$ samples and decimating the resulting spectrum) defines the PFB.
Formally, it is equivalent to Eq. \eqref{eqn:wdft}; however, the term \textit{critically sampled} (i.e. $M = K$) implies that the $N$-length windows will now overlap.
The term ``polyphase'' derives from the fact that each block of $K = N/P$ samples (known as \textit{taps}) in $x[n]$ is included in multiple applications of the DFT, but appearing at a different relative phase in each case.

One of the great advantages of the critically sampled PFB is the existence of a mathematically equivalent but computationally efficient implementation.
It can be shown that Eq. \eqref{eqn:wdft} is equivalent to first segmenting the windowed time series into taps, summing their respective samples element-wise, and performing a single DFT on the resulting array (now also of size $K$), i.e.
\begin{equation}
    X_k[m] = \sum_{n=0}^{K-1} b[n]\,e^{-2\pi jkn/K},
    \label{eqn:pfb}
\end{equation}
where
\begin{equation*}
    b[n] = \sum_{\rho=0}^{P-1} h[n + K\rho]\,x[n + mM + K\rho].
\end{equation*}
A short proof of this equivalence is given in \citet{Harris2011}.
The procedure described by Eq. \eqref{eqn:pfb} is called the \textit{weighted overlap-add} algorithm, and is illustrated in Fig. \ref{fig:pfb}.
\begin{figure}[t]
    \centering
    \includegraphics[width=\columnwidth]{example-image-a}
    \caption{A diagramatic representation of the PFB algorithm, as defined in Eq. \eqref{eqn:pfb}.}
    \label{fig:pfb}
\end{figure}

% There is some ambiguity about whether this definition includes the correct set of phases, which differ depending on whether the filterbank is defined on [0,M) or [-M/2, M/2).
% It may turn out there is an extra phase ramp that's needed in Eq. \eqref{eqn:filter} below.
% See Harris et al. (2011) for a fuller discussion of this point.

\subsection{MWA implementation of the fine PFB}

The first stage (coarse) PFB is described in \citet{Prabu2015}, and here we only document a few details pertaining to the second stage (fine) PFB.
A PFB is specified by (1) the number of output channels, $K$, (2) the number of taps, $P$, and (3) the analysis filter, $h[n]$.
For the MWA, $K = 128$ (giving fine channels $10\,$kHz wide), $P = 12$, and
\begin{equation}
    h[n] =
        \begin{cases}
            w_H[n]\,w_s[n], & 0 \le n < N, \\
            0               & \text{otherwise}
        \end{cases}
    \label{eqn:filter}
\end{equation}
where
\begin{equation*}
    w_H[n] = \sin^2\bigg(\frac{\pi (n+1)}{N+1}\bigg)
\end{equation*}
is the Hanning window, and
\begin{equation*}
    w_s[n] = \sinc\bigg(\frac{\pi(n + 1 - N/2)}{K}\bigg)
\end{equation*}
is the scaled $\sinc(x) = \sin(x)/x$ function.
It can be easily checked that $h[n]$ is defined to be symmetric around sample $n = 767 = N/2-1$.
The analysis filter is shown in Fig. \ref{fig:filter}.
\begin{figure}[t]
    \centering
    \includegraphics[width=\columnwidth]{filter}
    \caption{Top: The coefficients of the MWA's fine PFB analysis filter, defined in Eq. \eqref{eqn:filter}, which is composed of a Hanning window multiplied to a $\sinc$ function. Bottom: The frequency response of the analysis filter (black, solid), showing negligible attenuation across approximately $10\,$kHz (the bandwidth of a fine channel) and strong attenuation elsewhere. The frequency response is repeated for adjacent channels on either side (grey, dashed) showing crossover points on the channel edges at $-3\,$dB.}
    \label{fig:filter}
\end{figure}
The MWA's fine PFB is critically sampled, with $M = K = 128$.
The rationale behind the particular design choices for the MWA's fine PFB is beyond the scope of this paper---for the purposes of creating a synthesis filter, it is sufficient to know merely how the analysis filter is defined\footnote{Eq. \eqref{eqn:filter} is defined on $\mathbb{R}$, but the actual implementation on the MWA's filed-programmable gate arrays (FPGAs) defines the analysis filter coefficients on $\mathbb{Z}$. The exact implemented values, $h^\ast[n]$, can be obtained from $h[n]$ via $h^\ast[n] \equiv \lfloor\alpha h[n]\rceil$, where $\lfloor\cdot\rceil$ denotes rounding to the nearest integer and $\alpha = 117963.875$.}, and the fact that the PFB is critically sampled.

The fine PFB is implemented on [TODO: make/model] field-programmable gate arrays (FPGAs) and was designed in such a way to accommodate the data rates and bit depths set by the surrounding hardware.
The input signal values are signed (5+5)-bit complex integers, and the final outputs are (4+4)-bit complex integers.
The loss of precision associated with the demotion of 1 bit naturally places limits on the ability for any synthesis filter to perfectly reconstruct the original coarse channel time series, which is analysed for our system below.
The full details of the FPGA implementation are given in the appendix.

\section{Synthesis filter}
\label{sec:ipfb}

\subsection{Design}

The spectral output of the PFB, $X_k[m]$, can be used to reconstruct the time series $\hat{x}[n]$ by means of a \textit{synthesis filter}.
The hat signifies the fact that the resulting time series does not necessarily equal the original input to the PFB, $x[n]$, since one is free to choose the synthesis filter itself, $f$:
\begin{equation}
    \hat{x}[n] = \sum_{m = 0}^{M-1} f[n - mM]\,
        \frac{1}{K} \sum_{k=0}^{K-1} X_k[m]\,e^{2\pi jkn/K}.
    \label{eqn:ipfb}
\end{equation}
The precise condition for $\hat{x}[n] = x[n]$ for a critically sampled PFB is \citep[proven in][]{Crochiere1983}:
\begin{equation}
    \lambda(s) = \sum_{m=0}^{M-1} f[n-mM]\,h[mM - n + sM] = \Kron
    \label{eqn:invertibility_condition}
\end{equation}
for all values of $n$, where $\Kron$ is the Kronecker delta.
Eq. \eqref{eqn:invertibility_condition} means that the synthesis filter must ``convolve'' with the analysis filter (where the translation part of the convolution is restricted to step sizes of $M$) to produce an impulse.

Whether this condition is perfectly met clearly depends on the choice of analysis and synthesis filters.
However, even a synthesis filter which only approximately satisfies Eq. \eqref{eqn:invertibility_condition} for a given analysis filter (i.e. $\lambda(s) \approx \Kron$) will produce a time series approximates the original coarse channel time series (i.e. $\hat{x}[n] \approx x[n]$).
The more Eq. \eqref{eqn:invertibility_condition} departs from the Kronecker delta function, the more artefacts will appear in the time domain.
In practice, the choice of synthesis filter is often obliged to be a compromise between ease of implementation and an acceptable level of imperfection in the reconstructed time series.

For the filter $h[n]$ defined in Eq. \eqref{eqn:filter}, it is found that choosing
\begin{equation}
    f[n] = \frac{h[-n]}{H},
    \label{eqn:synthesisfilter}
\end{equation}
meets the invertibility condition sufficiently closely for our purposes.
$H = \sum_{n=0}^{N-1} h[n]$ is a normalising factor.
The value of \eqref{eqn:invertibility_condition} is illustrated in Fig. \ref{fig:inverse_condition}, in which it can be readily seen that $\lambda(s)$ closely approximates, but does not exactly equal, a delta function.
The quantitative effect of this analysis-synthesis pair is discussed in Section \ref{sec:fidelity}.
\begin{figure}
    \centering
    \includegraphics[width=\columnwidth]{inverse_condition.eps}
    \caption{The condition for invertibility, Eq. \eqref{eqn:invertibility_condition}, demonstrated for the analysis filter given in Eq. \eqref{eqn:filter} and the synthesis filter given in Eq. \eqref{eqn:synthesisfilter}. The fact that $\lambda(s)$ only approximates the delta function gives rise to spurious artefacts (``ringing'') in the time domain, which can be seen in Fig. (TODO).}
    \label{fig:inverse_condition}
\end{figure}

\subsection{Implementation}

We have implemented the synthesis filter defined in Eq. \eqref{eqn:synthesisfilter} as an optional component of the MWA-VCS beamforming software, \vcstools{}\footnote{\url{https://github.com/CIRA-Pulsars-and-Transients-Group/vcstools}}, described in \citet{Ord2019}.
In this mode, a time series reconstructed from the beamformed fine channelised data is written out for each coarse channel as two separate polarisation streams (i.e. without converting to Stokes parameters) in the VDIF file format \citep{Whitney2009}.
This format was chosen because it is supported by the coherent de-dispersion functionality of DSPSR\footnote{\url{http://dspsr.sourceforge.net/}} \citep{VanStraten2011b}, a software suite for processing pulsar time series.

The final stage before writing out the time series to file is the conversion from the complex floating point output of the synthesis operation into a signed 8-bit complex integer format required by the VDIF format.
Each second of data is independently mean-subtracted and normalised in order to avoid clipping errors.
It is worth noting that the mean-subtraction will mitigate to some degree the mean offset introduced by rounding errors in the analysis PFB (see the Appendix for details).

Viewed as a linear operation, Eq. \eqref{eqn:ipfb} is ideally suited for GPUs, and we have implemented it in \vcstools{} for NVIDIA's CUDA architecture.
Rather than use existing implementations of the implied inverse DFT, the $N \times K$ exponential terms (the so-called ``twiddle factors'') are pre-calculated and stored in a 2D array of double-precision floating point numbers on the GPUs.
These are then accessed as required for the calculation of a given sample $\hat{x}[n]$.
The whole pipeline (beamforming and synthesis) runs faster than real time\footnote{Verified for CUDA compute capability $>3.5$.}, unless throttled by I/O limitations of the computer system it is running on.

\subsection{Fidelity of reconstructed time series}
\label{sec:fidelity}

The major challenge in verifying the fidelity of the back-to-back analysis-synthesis filter pair is the fact that the analysis PFB only exists on the FPGAs used in production and not as stand-alone software than can be fed arbitrary input.
This makes conducting standard impulse response tests impossible, unless the exact performance of the PFB can be reproduced.
We have therefore attempted to replicate the PFB in software; however, the replication was not perfect, causing a small difference between the our model analysis-synthesis back-to-back system, and the analysis-synthesis system used in production.

In the fidelity tests presented in this section, there are therefore a number of sources of error, all of which cause the reconstructed coarse channel time series, $\hat{x}[n]$, to differ from the original input time series, $x[n]$:
\begin{itemize}
    \item the imperfect replication of the forward PFB, estimated to contribute noise-like error at the $-20\,$dB level (``replication error'', see Appendix for details);
    \item the error associated with the demotion of the input (5+5)-bit complex integers ($x[n]$) to the (4+4)-bit complex integer format output by the PFB (``quantisation error'', also see Appendix); and
    \item the error caused by the fact that the synthesis filter ($f[n]$) does not exactly complement the analysis filter ($h[n]$) in the sense described by Eq. \eqref{eqn:invertibility_condition} (``filter error'').
\end{itemize}
Although knowing the relative contributions of quantisation and filter errors is useful for improving the system (since the latter may be mitigated by identifying a better synthesis filter), it is only necessary to know their joint contribution for the purposes of characterising the analysis-synthesis system.
This contribution is revealed in an impulse response test, the results of which are shown in Fig. \eqref{fig:impulse_response}.
\begin{figure}
    \centering
    \includegraphics[width=\columnwidth]{compare_coarse_imp.eps}
    \caption{The response of the back-to-back analysis-synthesis system to a finite impulse. The coarse-channelised output has been arbitrarily scaled to have a comparable magnitude to the original (5+5)-bit impulse, and the original impulse has been shifted slightly to the left for visual clarity. The spurious artefacts seen on either side of the central pulse at intervals of 64 samples are dominated by the so-called ``filter error'' (see text).}
    \label{fig:impulse_response}
\end{figure}

As revealed by the impulse response test, our system is capable of reproducing the original impulse with high fidelity, despite the fact that the chosen synthesis filter is not ideal.
The main discrepancy appears in the form of temporal ``echoes'' of the original impulse occurring at intervals of 64 coarse channel samples (i.e. half the size of one tap, equal to $50\,\mu$s for our sampling rate of $1.28\,$MHz).
Although the power in the echoes is small compared to the central impulse (at roughly the $-10\,$dB level), it is important to realise that the echoes always appear at the same locations relative to it.
Therefore, echoes of individual pulses from a pulsar signal will always contribute to the same phase bins when the time series is folded at the pulsar's rotation period.
Any structure seen on this time scale must therefore always be regarded with suspicion.

\section{Verification with pulsar observations}
\label{sec:pulsardata}

\section{Conclusion}

The MWA-VCS telescope system outputs dynamic spectra with a frequency resolution of $10\,$kHz and a time resolution of $100\,\mu$s, which is suitable for many pulsar applications, as demonstrated in several pulsar science papers published to date \citep[e.g.][]{Oronsaye2015,McSweeney2017,Bhat2018}.
In this paper, we have presented an algorithm to undo the fine channelisation stage (fine PFB) of the VCS pipeline by using a synthesis polyphase filter, implemented as part of our processing software suite, \vcstools{}.
The result is a high-fidelity reconstruction of the coarse channelised (pre-PFB) time series, suitable for high-time resolution studies of MSPs and other rapid transient signals.
Although the reconstruction is not perfect, the introduced errors are quantified (up to $-10\,$dB in certain samples) and any spurious artefacts can be identified by virtue of the known timescale of their recurrence ($50\,\mu$s).

\begin{appendix}

\section{The FPGA implementation of the fine PFB}

Each coarse channel is independently processed by dedicated FPGAs to convert (5+5)-bit complex integers sampled at $1.28\,$MHz into a series of spectra composed of $128\times$(4+4)-bit complex integers sampled at $10\,$kHz.
The PFB is implemented in two stages: (1) a ``front-end'' stage which prepares the array $b[n]$ (see Eq. \eqref{eqn:pfb}), and (2) the ``FFT'' stage, which calculates the 128-point spectrum, $X_k[m]$.

The first stage involves a multiplication of a window of 1536 consecutive coarse channel samples with the analysis filter shown in Fig. \ref{fig:filter}, and then a summation of the 12 taps together to produce a single array of 128 complex integers.
The combination of the allowed input values $[-16, 15]$ and the filter values guarantees that the magnitudes of the summed numbers do not exceed $2^{22} = 4194304$.
At this stage of the processing, they are stored as 48-bit signed integers, of which only the bottom 21 bits are therefore significant.
Each integer $n$ (either real or imaginary) is then reduced from 48 bits to 8 bits in the following manner.
If $n$ is positive, then bits 14 through 21 (counting from the least significant bit) are selected to form the 8-bit integer, and 1 is subsequently added if bit 13 is 1.
This is equivalent to rounding the number $n/2^{14}$ to the nearest integer, where fractional values of 0.5 are always rounded up.
If $n$ is negative, then bits 14 through 21 are selected, but no rounding occurs.
This is equivalent to applying the floor operation to $n/2^{14}$.
It should be noted that this rounding scheme introduces a bias into the distribution of values.
In particular, the distribution of 8-bit values has a different mean than the distribution of the original 5-bit values, and it results in an artificial deficit in the number of values that get rounded to zero.
The rounding scheme and its effect on the distribution are illustrated in Fig. \ref{fig:pre_fft_distributions}, including a displaced mean which artificially adds power to the DC bin of the spectrum.
\begin{figure}[t!]
    \centering
    \includegraphics[width=\columnwidth]{pre_fft_distributions.eps}
    \caption{The first-stage (i.e. pre-FFT) rounding scheme implemented in the MWA FPGAs compared with a symmetric scheme. The top panel illustrates the two rounding schemes (each has been given a slightly different $y$-offset for visual clarity). A population of 5-bit samples was drawn from a rounded Gaussian distribution with mean $\mu = 0$ and standard deviation $\sigma = 2$. The vertical dashed lines show the means of the distributions after the population has been subjected to the first stage of the PFB (i.e. converted to 8-bit integers) and rounded according to the two different schemes. The bottom panel compares the distributions of the resulting population of 8-bit samples.}
    \label{fig:pre_fft_distributions}
\end{figure}

The second stage calculates the spectrum of $b[n]$ using the standard fixed point FFT algorithm that is implemented on [make and model] FPGAs.
The output values are scaled and (symmetrically) rounded, producing (4+4)-bit output values.

As described in the main text, it was necessary to replicate the function of the fine PFB in software in order to conduct impulse tests of the analysis-synthesis pair.
Our CPU-based implementation differs from the algorithm described above only by the use of the FFTW library\footnote{\url{http://www.fftw.org/}} for the FFT stage, which uses (and outputs) floating point values.
Nevertheless the resulting spectrum was found to contain a small number of quantisation ``errors'': slightly under $1\%$ of the output 4-bit values differed from the FPGA-produced values by 1.
To quantify the effect of these quantisation errors, we recorded a small amount of coarse channel data (dominated by telescope noise) along with the contemporaneous spectrum output by the FPGA PFB.
We used the GPU-based synthesis filter described in Section \ref{sec:ipfb} to reconstruct the coarse channel data from both the FPGA spectrum and the CPU spectrum generated by our own implementation.
We found the results to differ from each other at less than the $-20\,$dB power level, which is much less than the estimated difference between the reconstructed coarse channel data and the original.


\end{appendix}

%%% SAMPLE %%%
%\begin{table}
%\caption{This is an example of table caption.}
%\centering
%\begin{tabular}{@{}cc@{}}
%\hline\hline
%Dimension & Classification accuracy \\
%\hline%
% 1  & 0.6232$^{(a)}$ \\
% 2  & 0.9635 \\
% 3  & 0.9724 \\
% 4  & 0.9690 \\
% 5  & 0.9840 \\
% 6  & 0.9842 \\
% 7  & 0.9873 \\
% 8  & 0.9884 \\
% 9  & 0.9873 \\
% 10 & 0.9898 \\
% 11 & 0.9914 \\
%\hline\hline
%\end{tabular}
%\label{tab1}
%\medskip
%\tabnote{$^a$This is an example of table footnote}
%\tabnote{This is an example of table footnote}
%\tabnote{This is an example of table footnote}
%\end{table}
%
%\begin{acknowledgements}
%This is a multiline text of acknowledgments. We are met here on a great battlefield of that war. We have come to dedicate a portion of it as a final resting place for those who here gave their lives that that nation might live.
%\end{acknowledgements}
%
%
%\begin{appendix}
%
%\section{AN EXAMPLE OF APPENDIX HEAD}
%
% Consider a data set
%\begin{equation}
%S=(f_{ij})_{m\times n}
%\end{equation} the \(i\)th
%data point of which is
%\[ (f_{i1}, . . . , f_{in}).\]
% Let $\overline{f}_q=\frac{1}{m}\sum_{i=1}^mf_{iq}$ and $\sigma_q$ The brave men, living and dead, who struggled, here, have consecrated it far above our poor power to add or detract. Suppose that
%\[X_i=(x_{i1},\dots,x_{in}) \indent (i=1,\dots, m),\]
%where $x_{ij}=(f_{ij}-\overline{f}_j)/\sigma_j $ and
%\[B=(X_1^T,\dots,X_m^T)^T.\]
% Then we can show that
%\[C=B^TB=\sum\limits_{i=1}^m X_i^TX_i=(C_{jk})_{n\times n},\]
%where $C_{jk}=\sum_{i=1}^mx_{ij}x_{ik}$ is the correlation matrix. Our goal is to find a normalized vector
%$$a_1=(a_{11},a_{12},\dots,a_{1n})^T$$
% such that the projection of the standardized data
%\[X_ia_1=\sum\limits_{k=1}^n x_{ik}a_{1k},\]
%\noindent then $Ba_1$
% \[a_1^TB^T ¡¤ Ba_1=a_1^TCa_1.\]
% Our goal is to maximize this value under the constraint $a_1^Ta_1=1$. Let $\lambda_{\rm max}$ be the largest eigenvalue of
% $C$. According to the Rayleigh--Ritz theorem, $a_1$ can be obtained by solving
% \[Ca_1= \lambda_{\rm max}a_1.\]
%But in a larger sense we can not dedicate -- we can not consecrate -- we can not hallow this ground. The brave men, living and dead, who struggled, here, have consecrated it far above our poor power to add or detract. The world will little note, nor long remember, what we say here, but can never forget what they did here. It is for us, the living, rather to be dedicated here to the unfinished work which they have, thus far, so nobly carried on \cite{abt1981}. It is rather for us to be here dedicated to the great task remaining before us  that from these honoured dead we take increased devotion to that cause for which they here gave the last full measure of devotion  that we here highly resolve that these dead shall not have died in vain; that this nation shall have a new birth of freedom; and that this government \cite{abt1984b} of the people, by the people, for the people, shall not perish from the earth.
%\end{appendix}
%%% END SAMPLE %%%

\bibliographystyle{pasa-mnras}
\bibliography{biblio.bib}

\end{document}

